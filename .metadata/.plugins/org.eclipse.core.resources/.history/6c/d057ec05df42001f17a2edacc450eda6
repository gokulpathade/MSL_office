package com.vm.model.service;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.stereotype.Service;

import com.vm.dto.EmailDto;
import com.vm.model.User;
import com.vm.model.Vendor;
import com.vm.model.repository.EmailRepository;
import com.vm.model.repository.UserRepository;
import com.vm.model.repository.VendorRepository;

@Service
public class EmailService {

    @Autowired
    private JavaMailSender mailSender;

    @Autowired
    private EmailRepository emailRepository;

    @Autowired
    private VendorRepository vendorRepository;

    @Autowired
    private UserRepository userRepository; // Add UserRepository

    public void sendEmail(List<EmailDto> emailDTOs) {
        for (EmailDto emailDTO : emailDTOs) {
            Vendor vendor = vendorRepository.findById(emailDTO.getVendor().getId()).orElseThrow(); // Add error handling
            User user = userRepository.findById(emailDTO.getUser().getId()).orElseThrow(); // Add error handling

            String subject = "Payment Notification";
            String message = String.format("Sending payments to vendor %s at UPI %s by user %s", vendor.getName(), vendor.getUpi(), user.getUsername());

            SimpleMailMessage mailMessage = new SimpleMailMessage();
            mailMessage.setTo(vendor.getEmail());
            mailMessage.setSubject(subject);
            mailMessage.setText(message);
            mailSender.send(mailMessage);

            // Save sent email information to the database
            Email email = new Email();
            email.setVendor(vendor);
            email.setUser(user); // Associate user with email
            email.setRecipientEmail(vendor.getEmail());
            emailRepository.save(email);
        }
    }
}